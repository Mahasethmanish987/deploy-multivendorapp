name: Deploy to Production

on:
  push:
    branches: [master]

jobs:
  deploy-instance1:
    runs-on: ubuntu-latest
    name: Deploy to Instance 1
    steps:
      - name: Checkout code 
        uses: actions/checkout@v4

      - name: Add EC2 Host to Known Hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          for i in {1..5}; do
            ssh-keyscan -H ${{ secrets.EC2_HOST1 }} >> ~/.ssh/known_hosts 2>&1 && {
              echo "‚úÖ SSH keyscan succeeded on attempt $i"
              break
            } || {
              echo "üîÑ SSH keyscan attempt $i failed. Retrying in 3 seconds..."
              sleep 3
            }
          done
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST1 }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY1 }}
          script: |
            set -e
            echo "üöÄ Starting deployment on Instance 1"
            
            USER="${{ secrets.EC2_USERNAME }}"
            APP_DIR="/home/$USER/foodonline"
            
            # Setup directory
            echo "üìÅ Using directory: $APP_DIR"
            sudo mkdir -p "$APP_DIR"
            sudo chown -R $USER:$USER "$APP_DIR"
            cd "$APP_DIR"
            
            # Repository setup
            if [ ! -d .git ]; then
              git init
              git remote add origin https://github.com/Mahasethmanish987/deploy-multivendorapp.git
            fi
            
            # Get latest code
            echo "‚¨áÔ∏è Fetching latest code"
            git fetch origin
            git reset --hard origin/master
            
            # Ensure Docker is available
            echo "üê≥ Verifying Docker environment"
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              sudo apt-get update
              sudo apt-get install -y docker.io
            fi
            
            # Install Docker Compose if missing
            if ! command -v docker-compose &> /dev/null; then
              echo "Installing Docker Compose..."
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
            fi
            
            # Start Docker service
            sudo systemctl start docker || true
            sudo systemctl enable docker || true
            
            # Add user to docker group
            if ! groups $USER | grep -q '\bdocker\b'; then
              sudo usermod -aG docker $USER
              exec sg docker -c "$0"
            fi
            
            # Deploy application
            echo "üèóÔ∏è Building and starting containers"
            docker-compose down --remove-orphans || true
            docker-compose build --no-cache
            docker-compose up -d --force-recreate
            
            # Health check
            echo "ü©∫ Starting health checks"
            for i in {1..10}; do
              sleep 10
              if docker-compose ps | grep -q '(healthy)'; then
                echo "‚úÖ Services are healthy"
                break
              else
                echo "‚è≥ Waiting for services to become healthy (attempt $i/10)"
                docker-compose ps
              fi
            done
            
            echo "üì¶ Final container status:"
            docker-compose ps -a
            echo "‚úÖ Deployment complete on Instance 1"

  deploy-instance2:
    runs-on: ubuntu-latest
    name: Deploy to Instance 2
    steps:
      - name: Checkout code 
        uses: actions/checkout@v4

      - name: Add EC2 Host to Known Hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          for i in {1..5}; do
            ssh-keyscan -H ${{ secrets.EC2_HOST2 }} >> ~/.ssh/known_hosts 2>&1 && {
              echo "‚úÖ SSH keyscan succeeded on attempt $i"
              break
            } || {
              echo "üîÑ SSH keyscan attempt $i failed. Retrying in 3 seconds..."
              sleep 3
            }
          done
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST2 }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY2 }}
          script: |
            set -e
            echo "üöÄ Starting deployment on Instance 2"
            
            USER="${{ secrets.EC2_USERNAME }}"
            APP_DIR="/home/$USER/foodonline"
            
            # Setup directory
            echo "üìÅ Using directory: $APP_DIR"
            sudo mkdir -p "$APP_DIR"
            sudo chown -R $USER:$USER "$APP_DIR"
            cd "$APP_DIR"
            
            # Repository setup
            if [ ! -d .git ]; then
              git init
              git remote add origin https://github.com/Mahasethmanish987/deploy-multivendorapp.git
            fi
            
            # Get latest code
            echo "‚¨áÔ∏è Fetching latest code"
            git fetch origin
            git reset --hard origin/master
            
            # Ensure Docker is available
            echo "üê≥ Verifying Docker environment"
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              sudo apt-get update
              sudo apt-get install -y docker.io
            fi
            
            # Install Docker Compose if missing
            if ! command -v docker-compose &> /dev/null; then
              echo "Installing Docker Compose..."
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
            fi
            
            # Start Docker service
            sudo systemctl start docker || true
            sudo systemctl enable docker || true
            
            # Add user to docker group
            if ! groups $USER | grep -q '\bdocker\b'; then
              sudo usermod -aG docker $USER
              exec sg docker -c "$0"
            fi
            
            # Deploy application (SAME AS INSTANCE1)
            echo "üèóÔ∏è Building and starting containers"
            docker-compose down --remove-orphans || true
            docker-compose build --no-cache
            docker-compose up -d --force-recreate
            
            # Health check
            echo "ü©∫ Starting health checks"
            for i in {1..10}; do
              sleep 10
              if docker-compose ps | grep -q '(healthy)'; then
                echo "‚úÖ Services are healthy"
                break
              else
                echo "‚è≥ Waiting for services to become healthy (attempt $i/10)"
                docker-compose ps
              fi
            done
            
            echo "üì¶ Final container status:"
            docker-compose ps -a
            echo "‚úÖ Deployment complete on Instance 2"